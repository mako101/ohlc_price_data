# Python Assignment

A simple API server to get financial data. Built with FastAPI, MySQL and Docker.


## Installation and Setup

Clone the project.

```bash
git clone git@github.com:mako101/ctw-code-test.git
```

Change to the repository's root directory
```bash
cd ctw-code-test
```

Create the virtual environment (if desired) and install the requirements (needed for `get_raw_data.py` script)

```bash
virtualenv venv
. venv/bin/activate
pip install -r requirements.txt
```

Set up the required variables 

You will need to specify your own [Alpha Vantage](https://www.alphavantage.co/) API key

As well as the MySQL database connection string

You can do so either via the use of `.env` file or through the environmental variables

Copy `.env` file from `.env.sample` file. Update `API_KEY` key with your key.

The default database connection string is already specified in the sample file

```bash
cp .env.sample .env
```

Alternatively, you can pass  the `API_KEY` and `MYSQL_DB` environmental variables

```bash
export API_KEY=<YOUR_API_KEY>
export MYSQL_DB=<DB_connection_string>
```


## Bring up Services and Retrieve Data

Start the database and API containers via `docker-compose`

```bash
docker-compose up
```
Once the containers are up, run `get_raw_data.py` to get the latest stock data (last 2 weeks) from Alpha Vantage API and store it in the database

```bash
python3 get_raw_data.py
```
Now the application is ready to be used


## Using the API


### Web UI

In addition to the requested URLs, an autogenerated interactive API documentation / basic Web UI is available for convenience 

```
http://localhost:5000/docs#/
```


### Get Financial Data

Example Request:
```bash
curl -X GET "http://localhost:5000/api/financial_data?start_date=2023-03-01&end_date=2023-03-04&symbol=IBM&limit=2&page=2"
```

Example Response:
```json
{
  "data": [
    {
      "close_price": 174.2,
      "symbol": "AAPL",
      "date": "2023-05-22",
      "id": 9,
      "open_price": 173.98,
      "volume": 43570900
    }
  ],
  "pagination": {
    "count": 9,
    "page": 1,
    "limit": 1,
    "pages": 9
  },
  "info": {
    "error": ""
  }
}
```
Query parameters:
- `start_date`: start date of the data, format: `YYYY-MM-DD`, default: two weeks ago
- `end_date`: end date of the data, format: `YYYY-MM-DD`, default: today
- `symbol`: symbol of the stock. Only `IBM` and `AAPL` are supported, default: `AAPL`
- `limit`: number of records per page, default: `5`
- `page`:  page number, default: `1`.


### Get Statistics
Example Request:
```bash
curl -X GET "http://localhost:5000/api/statistics?start_date=2023-03-01&end_date=2023-03-04&symbol=IBM"
```

Example Response:
```json
{
  "data": {
    "start_date": "2023-05-22",
    "end_date": "2023-06-05",
    "symbol": "AAPL",
    "average_daily_open_price": 175.22,
    "average_daily_close_price": 175.73,
    "average_daily_volume": 59614588
  },
  "info": {
    "error": ""
  }
}
```
Query parameters:
- `start_date`: start date of the data, format: `YYYY-MM-DD`, default: two weeks ago
- `end_date`: end date of the data, format: `YYYY-MM-DD`, default: today
- `symbol`: symbol of the stock. Only `IBM` and `AAPL` are supported, default: `AAPL`


## Selected Packages and Rationale
- FastAPI: high-performance, easy to use API library, with an added bonus of auto-generated Web UI / documentation
- SQLAlchemy: Python SQL toolkit and Object Relational Mapper. Makes it easy to use any supported DB backend with minimal changes to the code
- pymysql: Python MySQL client, required for SQLAlchemy
- cryptography: cryptography library, required for pymysql
- uvicorn: Python-based ASGI web server, works well with FastAPI
- requests: HTTP library, used to make requests to Alpha Vantage API
- python-dotenv: tool to load environment variables from `.env` file, allows reading of sensitive information from outside the codebase

## Database Migration

An easy way to perform automatic migrations is by using [alembic](https://alembic.sqlalchemy.org/en/latest/index.html) database migration tool, which is designed to be used in conjunction with SQLAlchemy

Once installed and configured, it will be possible to generate migration code by running

```bash
alembic revision --autogenerate -m "Added x y z"
```


